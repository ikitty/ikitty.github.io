<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Starfield</title>
<meta http-equiv="content-type" content="text/html;charset=ISO-8859-1">
<meta http-equiv="content-language" content="en">
<meta name="viewport" content="width=device-width,user-scalable=0,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
<style type="text/css">
    body  {margin:0;padding:0;background-color:#ddd;background-size:cover;overflow:hidden}
</style>
</head>


<body>

<canvas id="starfield"></canvas>
<script>
    var test = true;

    var flag = true;
    var n = 50;
    var w = document.documentElement.clientWidth;
    var h = document.documentElement.clientHeight;
    var x = 0;
    var y = 0;
    var z = 0;

    var star_color_ratio = 0;
    var star_x_save, star_y_save;
    var star_ratio = 256;
    var star_speed = 4;
    var star = new Array(n);
    var opacity = 0.1;

    //target 
    var target_x = 0;
    var target_y = 0;

    //source
    var src_x = 0;
    var src_y = 0;

    var canvas_x = 0;
    var canvas_y = 0;
    var context;
    var key;

    var timeout;
    var fps = 50;

    var bgImg = new Image();
    document.domain = 'qq.com';

    function init() {
        var a = 0;
        for (var i = 0; i < n; i++) {
            star[i] = new Array(5);
            star[i][0] = Math.random() * w * 2 - x * 2;
            star[i][1] = Math.random() * h * 2 - y * 2;
            star[i][2] = Math.round(Math.random() * z);
            star[i][3] = 0;
            star[i][4] = 0;
        }
        var starfield = document.getElementById('starfield')
        starfield.width = w;
        starfield.height = h;
        context = starfield.getContext('2d');
        context.lineCap='round';
        // context.fillStyle = 'rgb(0,0,0)';
        context.strokeStyle = 'rgb(255,100,0)';

        bgImg.onload = function () {
            context.drawImage(this, 0, 0);
        }
        bgImg.src = 'http://t7.qq.com/act/a20151109weilan/images/mobile_bg.jpg' ;
    }

    function setBg() {
        // body...
    }

    var R = 100 
        ,theta = 0 
        ,thetaStep = 2
        ,xx=0
        ,yy=0
        ;

    function anim() {
        src_x = target_x - x;
        src_y = target_y - y;
        // context.clearRect(0,0, w, h);

        // context.fillStyle = 'rgba(0,0,0, 0.1)';
        // context.fillRect(0, 0, w, h);

        bgImg.onload  = function() {
            context.drawImage(this, 0, 0);
            var ImageData = context.getImageData(0,0,bgImg.width, bgImg.height);
            for(var i=0;i<bgImg.height;i++) {
                for(var j=0;j<bgImg.width;j++) {
                    ImageData.data[((i*(bgImg.width*4)) + (j*4) + 3)] = 127;//opacity = 0.5 [0-255]
                }
            }
            context.putImageData(ImageData,0,0);//put image data back
        }
        bgImg.src = 'http://t7.qq.com/act/a20151109weilan/images/mobile_bg.jpg' ;
        
        for (var i = 0; i < n; i++) {
            test = true;
            star_x_save = star[i][3];
            star_y_save = star[i][4];
            star[i][0] += src_x >> 4;
            if (star[i][0] > x << 1) {
                star[i][0] -= w << 1;
                test = false;
            }
            if (star[i][0] < -x << 1) {
                star[i][0] += w << 1;
                test = false;
            }
            star[i][1] += src_y >> 4;
            if (star[i][1] > y << 1) {
                star[i][1] -= h << 1;
                test = false;
            }
            if (star[i][1] < -y << 1) {
                star[i][1] += h << 1;
                test = false;
            }
            star[i][2] -= star_speed;
            if (star[i][2] > z) {
                star[i][2] -= z;
                test = false;
            }
            if (star[i][2] < 0) {
                star[i][2] += z;
                test = false;
            }
            star[i][3] = x + (star[i][0] / star[i][2]) * star_ratio;
            star[i][4] = y + (star[i][1] / star[i][2]) * star_ratio;
            if (star_x_save > 0 && star_x_save < w && star_y_save > 0 && star_y_save < h && test) {
                context.lineWidth = (1 - star_color_ratio * star[i][2]) * 2;
                context.beginPath();
                context.moveTo(star_x_save, star_y_save);
                context.lineTo(star[i][3], star[i][4]);
                context.strokeStyle = 'rgb(255,100,0)';
                context.stroke();
                context.closePath();

            }
        }
                //test
                /*
                context.beginPath();
                xx = (R+10*thetaStep)*Math.cos(theta)+2*R;
                yy = (R+10*thetaStep)*Math.sin(theta)+2*R;

                theta += 0.2 ;
                context.moveTo(xx, yy);
                context.lineTo(xx+20, yy+10);

                context.strokeStyle = 'rgb(255,0,255)';
                context.stroke();
                context.closePath();
                */
        timeout = setTimeout('anim()', fps);
    }


    function start() {
        x = Math.round(w / 2);
        y = Math.round(h / 2);
        z = (w + h) / 2;
        star_color_ratio = 1 / z;
        target_x = x + 100;
        target_y = y +100;

        init();
        anim();
    }


    start();
</script>

</body>
</html>

